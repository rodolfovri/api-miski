using MediatR;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Miski.Application.Features.Compras.LlegadasPlanta.Commands.CreateLlegadaPlanta;
using Miski.Application.Features.Compras.LlegadasPlanta.Queries.GetLlegadaPlantaById;
using Miski.Application.Features.Compras.LlegadasPlanta.Queries.GetCompraVehiculoConLotes;
using Miski.Application.Features.Compras.LlegadasPlanta.Queries.GetComprasVehiculosActivos;
using Miski.Application.Features.Compras.LlegadasPlanta.Queries.GetVehiculosConComprasYRecepciones;
using Miski.Shared.DTOs.Base;
using Miski.Shared.DTOs.Compras;

namespace Miski.Api.Controllers.Compras;

[ApiController]
[Route("api/compras/llegadas-planta")]
[Tags("Compras")]
[Authorize]
public class LlegadaPlantaController : ControllerBase
{
    private readonly IMediator _mediator;

    public LlegadaPlantaController(IMediator mediator)
    {
        _mediator = mediator;
    }

    /// <summary>
    /// Obtiene todos los vehículos con sus compras ACTIVAS y detalles de lotes
    /// </summary>
    /// <remarks>
    /// Retorna todos los CompraVehiculo que tienen compras con estado "ACTIVO", mostrando:
    /// - Información del vehículo (placa, guía de remisión, fecha de registro)
    /// - Detalles de cada compra con sus lotes:
    ///   * Código del lote
    ///   * Sacos enviados (del lote original)
    ///   * Peso enviado (del lote original)
    ///   * Sacos recibidos (si ya llegó a planta)
    ///   * Peso recibido (si ya llegó a planta)
    ///   * Estado de la compra
    /// 
    /// Relación: CompraVehiculo (1) ? (N) CompraVehiculoDetalle ? (1) Compra ? (N) Lote
    /// 
    /// Solo se incluyen compras con estado "ACTIVO".
    /// </remarks>
    [HttpGet]
    public async Task<ActionResult<ApiResponse<IEnumerable<CompraVehiculoResumenDto>>>> GetComprasVehiculosActivos(
        CancellationToken cancellationToken = default)
    {
        try
        {
            var query = new GetComprasVehiculosActivosQuery();
            var result = await _mediator.Send(query, cancellationToken);

            return Ok(ApiResponse<IEnumerable<CompraVehiculoResumenDto>>.SuccessResult(
                result,
                "Compras de vehículos obtenidas exitosamente"
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<IEnumerable<CompraVehiculoResumenDto>>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Obtiene una llegada a planta por ID con detalles de lotes recibidos
    /// </summary>
    /// <remarks>
    /// Retorna información de la llegada a planta incluyendo:
    /// - Datos de la compra y usuario
    /// - Detalles de cada lote recibido con:
    ///   * Sacos asignados vs sacos recibidos
    ///   * Peso asignado vs peso recibido
    ///   * Diferencias calculadas
    ///   * Observaciones
    /// </remarks>
    [HttpGet("{id}")]
    public async Task<ActionResult<ApiResponse<LlegadaPlantaDto>>> GetLlegadaPlantaById(
        int id,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var query = new GetLlegadaPlantaByIdQuery(id);
            var result = await _mediator.Send(query, cancellationToken);

            return Ok(ApiResponse<LlegadaPlantaDto>.SuccessResult(
                result,
                "Llegada a planta obtenida exitosamente"
            ));
        }
        catch (Shared.Exceptions.NotFoundException ex)
        {
            return NotFound(ApiResponse<LlegadaPlantaDto>.ErrorResult(
                "Llegada a planta no encontrada",
                ex.Message
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<LlegadaPlantaDto>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Obtiene las compras con sus lotes de un CompraVehiculo específico
    /// </summary>
    /// <remarks>
    /// Retorna todas las compras asignadas a un vehículo con sus lotes, indicando:
    /// - Sacos asignados y peso asignado de cada lote
    /// - Si el lote ya fue recibido (YaRecibido = true/false)
    /// - Información de recepción si existe (sacos recibidos, peso recibido, observaciones)
    /// 
    /// Útil para registrar llegadas a planta basándose en el vehículo que llega.
    /// </remarks>
    [HttpGet("por-vehiculo/{idCompraVehiculo}")]
    public async Task<ActionResult<ApiResponse<CompraVehiculoConLotesDto>>> GetCompraVehiculoConLotes(
        int idCompraVehiculo,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var query = new GetCompraVehiculoConLotesQuery(idCompraVehiculo);
            var result = await _mediator.Send(query, cancellationToken);

            return Ok(ApiResponse<CompraVehiculoConLotesDto>.SuccessResult(
                result,
                "Compras con lotes obtenidas exitosamente"
            ));
        }
        catch (Shared.Exceptions.NotFoundException ex)
        {
            return NotFound(ApiResponse<CompraVehiculoConLotesDto>.ErrorResult(
                "CompraVehiculo no encontrado",
                ex.Message
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<CompraVehiculoConLotesDto>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Registra una nueva llegada a planta
    /// </summary>
    /// <remarks>
    /// Permite registrar la llegada de un lote de una compra a planta.
    /// 
    /// Campos requeridos:
    /// - IdCompra: ID de la compra que llega
    /// - IdUsuario: ID del usuario que registra la llegada
    /// - IdLote: ID del lote recibido
    /// - SacosRecibidos: Cantidad de sacos recibidos
    /// - PesoRecibido: Peso recibido en kg
    /// - FLlegada: Fecha de llegada
    /// 
    /// Validaciones:
    /// - La compra debe existir
    /// - El usuario debe existir
    /// - El lote debe existir y pertenecer a la compra
    /// - El lote no debe estar registrado previamente
    /// 
    /// Ejemplo de request:
    /// {
    ///   "idCompra": 1,
    ///   "idUsuario": 5,
    ///   "idLote": 1,
    ///   "sacosRecibidos": 30,
    ///   "pesoRecibido": 1495.50,
    ///   "fLlegada": "2024-01-20T14:30:00",
    ///   "observaciones": "Algunos sacos húmedos"
    /// }
    /// </remarks>
    [HttpPost]
    public async Task<ActionResult<ApiResponse<CreateLlegadaPlantaResponseDto>>> RegistrarLlegadaPlanta(
        [FromBody] CreateLlegadaPlantaDto request,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var command = new CreateLlegadaPlantaCommand(request);
            var result = await _mediator.Send(command, cancellationToken);

            return Ok(ApiResponse<CreateLlegadaPlantaResponseDto>.SuccessResult(
                result,
                "Llegadas a planta registradas exitosamente"
            ));
        }
        catch (Shared.Exceptions.ValidationException ex)
        {
            return BadRequest(ApiResponse<CreateLlegadaPlantaResponseDto>.ValidationErrorResult(ex.Errors));
        }
        catch (Shared.Exceptions.NotFoundException ex)
        {
            return NotFound(ApiResponse<CreateLlegadaPlantaResponseDto>.ErrorResult(
                "Entidad relacionada no encontrada",
                ex.Message
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<CreateLlegadaPlantaResponseDto>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Obtiene todos los vehículos con sus compras asignadas y detalles de recepción en planta
    /// </summary>
    /// <remarks>
    /// Retorna un reporte completo que hace match entre:
    /// - CompraVehiculo (vehículos con asignaciones)
    /// - CompraVehiculoDetalle (compras asignadas a cada vehículo)
    /// - LlegadaPlanta (registro de llegada de la compra)
    /// 
    /// Para cada vehículo muestra:
    /// - Información del vehículo y guía de remisión
    /// - Compras asignadas con:
    ///   * Para cada lote:
    ///     - Sacos asignados vs sacos recibidos
    ///     - Peso asignado vs peso recibido
    ///     - Diferencias calculadas
    ///     - Observaciones de recepción
    ///     - Estado de recepción (YaRecibido)
    /// 
    /// Permite filtrar por:
    /// - idCompraVehiculo: Ver un vehículo específico
    /// - idVehiculo: Ver todas las asignaciones de un vehículo
    /// 
    /// Útil para:
    /// - Ver qué compras van en cada vehículo
    /// - Verificar qué se ha recibido y qué falta
    /// - Control de diferencias entre lo enviado y lo recibido
    /// - Trazabilidad completa del proceso
    /// </remarks>
    [HttpGet("vehiculos-con-recepciones")]
    public async Task<ActionResult<ApiResponse<IEnumerable<VehiculoConComprasYRecepcionesDto>>>> GetVehiculosConComprasYRecepciones(
        [FromQuery] int? idCompraVehiculo = null,
        [FromQuery] int? idVehiculo = null,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var query = new GetVehiculosConComprasYRecepcionesQuery(idCompraVehiculo, idVehiculo);
            var result = await _mediator.Send(query, cancellationToken);

            return Ok(ApiResponse<IEnumerable<VehiculoConComprasYRecepcionesDto>>.SuccessResult(
                result,
                "Vehículos con compras y recepciones obtenidos exitosamente"
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<IEnumerable<VehiculoConComprasYRecepcionesDto>>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }
}