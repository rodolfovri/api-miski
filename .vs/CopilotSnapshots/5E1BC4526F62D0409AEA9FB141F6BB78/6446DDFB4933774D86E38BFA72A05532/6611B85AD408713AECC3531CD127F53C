using MediatR;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Miski.Application.Features.Compras.CompraVehiculos.Commands.CreateCompraVehiculo;
using Miski.Application.Features.Compras.CompraVehiculos.Commands.UpdateCompraVehiculo;
using Miski.Application.Features.Compras.CompraVehiculos.Queries.GetCompraVehiculos;
using Miski.Application.Features.Compras.CompraVehiculos.Queries.GetCompraVehiculoById;
using Miski.Application.Features.Compras.CompraVehiculos.Queries.GetComprasPorVehiculo;
using Miski.Shared.DTOs.Base;
using Miski.Shared.DTOs.Compras;

namespace Miski.Api.Controllers.Compras;

[ApiController]
[Route("api/compras/asignacion-vehiculos")]
[Tags("Compras")]
[Authorize]
public class CompraVehiculosController : ControllerBase
{
    private readonly IMediator _mediator;

    public CompraVehiculosController(IMediator mediator)
    {
        _mediator = mediator;
    }

    /// <summary>
    /// Obtiene todas las asignaciones de compras a vehículos con filtros opcionales
    /// </summary>
    /// <remarks>
    /// Permite filtrar por:
    /// - idVehiculo: Filtrar por vehículo
    /// - guiaRemision: Búsqueda parcial por guía de remisión
    /// </remarks>
    [HttpGet]
    public async Task<ActionResult<ApiResponse<IEnumerable<CompraVehiculoDto>>>> GetCompraVehiculos(
        [FromQuery] int? idVehiculo = null,
        [FromQuery] string? guiaRemision = null,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var query = new GetCompraVehiculosQuery(idVehiculo, guiaRemision);
            var result = await _mediator.Send(query, cancellationToken);
            
            return Ok(ApiResponse<IEnumerable<CompraVehiculoDto>>.SuccessResult(
                result, 
                "Asignaciones de compras a vehículos obtenidas exitosamente"
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<IEnumerable<CompraVehiculoDto>>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Obtiene compras por vehículo (asignadas y disponibles)
    /// </summary>
    /// <remarks>
    /// Retorna las compras de un vehículo específico, incluyendo:
    /// - Compras asignadas al vehículo (asignado: true) con información de guía de remisión
    /// - Compras sin asignar a ningún vehículo (asignado: false)
    /// 
    /// Este endpoint es útil para:
    /// - Ver qué compras ya tiene asignadas un vehículo
    /// - Ver qué compras están disponibles para asignar
    /// - Gestionar las asignaciones del vehículo
    /// 
    /// Las compras se ordenan con las asignadas primero, luego las disponibles.
    /// </remarks>
    [HttpGet("por-vehiculo/{idVehiculo}")]
    public async Task<ActionResult<ApiResponse<ComprasPorVehiculoDto>>> GetComprasPorVehiculo(
        int idVehiculo,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var query = new GetComprasPorVehiculoQuery(idVehiculo);
            var result = await _mediator.Send(query, cancellationToken);
            
            return Ok(ApiResponse<ComprasPorVehiculoDto>.SuccessResult(
                result, 
                "Compras por vehículo obtenidas exitosamente"
            ));
        }
        catch (Shared.Exceptions.NotFoundException ex)
        {
            return NotFound(ApiResponse<ComprasPorVehiculoDto>.ErrorResult(
                "Vehículo no encontrado",
                ex.Message
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<ComprasPorVehiculoDto>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Obtiene una asignación de compra a vehículo por ID
    /// </summary>
    [HttpGet("{id}")]
    public async Task<ActionResult<ApiResponse<CompraVehiculoDto>>> GetCompraVehiculoById(
        int id,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var query = new GetCompraVehiculoByIdQuery(id);
            var result = await _mediator.Send(query, cancellationToken);

            return Ok(ApiResponse<CompraVehiculoDto>.SuccessResult(
                result,
                "Asignación de compra a vehículo obtenida exitosamente"
            ));
        }
        catch (Shared.Exceptions.NotFoundException ex)
        {
            return NotFound(ApiResponse<CompraVehiculoDto>.ErrorResult(
                "Asignación de compra a vehículo no encontrada",
                ex.Message
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<CompraVehiculoDto>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Crea una nueva asignación de compras a vehículo
    /// </summary>
    /// <remarks>
    /// Permite asignar múltiples compras a un vehículo con una guía de remisión.
    /// 
    /// Campos requeridos:
    /// - IdVehiculo: ID del vehículo al que se asignan las compras
    /// - GuiaRemision: Número de guía de remisión (único, máx. 50 caracteres)
    /// - IdCompras: Lista de IDs de compras a asignar (mínimo 1)
    /// 
    /// Validaciones:
    /// - El vehículo debe existir
    /// - Todas las compras deben existir y estar en estado ACTIVO
    /// - Las compras no deben estar asignadas previamente a otro vehículo
    /// - La guía de remisión no debe estar duplicada
    /// 
    /// Ejemplo de request:
    /// {
    ///   "idVehiculo": 1,
    ///   "guiaRemision": "GR-2024-001",
    ///   "idCompras": [1, 2, 3]
    /// }
    /// </remarks>
    [HttpPost]
    public async Task<ActionResult<ApiResponse<CompraVehiculoDto>>> CreateCompraVehiculo(
        [FromBody] CreateCompraVehiculoDto request,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var command = new CreateCompraVehiculoCommand(request);
            var result = await _mediator.Send(command, cancellationToken);

            return CreatedAtAction(
                nameof(GetCompraVehiculoById), 
                new { id = result.IdCompraVehiculo }, 
                ApiResponse<CompraVehiculoDto>.SuccessResult(
                    result, 
                    "Asignación de compras a vehículo creada exitosamente"
                )
            );
        }
        catch (Shared.Exceptions.ValidationException ex)
        {
            return BadRequest(ApiResponse<CompraVehiculoDto>.ValidationErrorResult(ex.Errors));
        }
        catch (Shared.Exceptions.NotFoundException ex)
        {
            return NotFound(ApiResponse<CompraVehiculoDto>.ErrorResult(
                "Entidad relacionada no encontrada",
                ex.Message
            ));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<CompraVehiculoDto>.ErrorResult(
                "Error interno del servidor", 
                ex.Message
            ));
        }
    }

    /// <summary>
    /// Actualiza una asignación de compras a vehículo
    /// </summary>
    /// <remarks>
    /// Permite modificar el vehículo, la guía de remisión y las compras asignadas.
    /// 
    /// Campos requeridos:
    /// - IdCompraVehiculo: ID de la asignación a actualizar
    /// - IdVehiculo: ID del vehículo
    /// - GuiaRemision: Número de guía de remisión (único, máx. 50 caracteres)
    /// - IdCompras: Lista de IDs de compras a asignar (mínimo 1)
    /// 
    /// Validaciones:
    /// - La asignación debe existir
    /// - El vehículo debe existir
    /// - Todas las compras deben existir y estar en estado ACTIVO
    /// - Las compras no deben estar asignadas a OTRO vehículo (permite reasignar en el mismo)
    /// - La guía de remisión no debe estar duplicada (excepto la actual)
    /// 
    /// Nota: Los detalles anteriores se eliminan y se crean nuevos con las compras indicadas
    /// 
    /// Ejemplo de request:
    /// {
    ///   "idCompraVehiculo": 1,
    ///   "idVehiculo": 2,
    ///   "guiaRemision": "GR-2024-001-MOD",
    ///   "idCompras": [1, 2, 4, 5]
    /// }
    /// </remarks>
    [HttpPut("{id}")]
    public async Task<ActionResult<ApiResponse<CompraVehiculoDto>>> UpdateCompraVehiculo(
        int id,
        [FromBody] UpdateCompraVehiculoDto request,
        CancellationToken cancellationToken = default)
    {
        try
        {
            if (id != request.IdCompraVehiculo)
            {
                return BadRequest(ApiResponse<CompraVehiculoDto>.ErrorResult(
                    "ID inválido",
                    "El ID de la URL no coincide con el ID del cuerpo de la petición"
                ));
            }

            var command = new UpdateCompraVehiculoCommand(id, request);
            var result = await _mediator.Send(command, cancellationToken);

            return Ok(ApiResponse<CompraVehiculoDto>.SuccessResult(
                result,
                "Asignación de compras a vehículo actualizada exitosamente"
            ));
        }
        catch (Shared.Exceptions.NotFoundException ex)
        {
            return NotFound(ApiResponse<CompraVehiculoDto>.ErrorResult(
                "Asignación de compra a vehículo no encontrada",
                ex.Message
            ));
        }
        catch (Shared.Exceptions.ValidationException ex)
        {
            return BadRequest(ApiResponse<CompraVehiculoDto>.ValidationErrorResult(ex.Errors));
        }
        catch (Exception ex)
        {
            return StatusCode(500, ApiResponse<CompraVehiculoDto>.ErrorResult(
                "Error interno del servidor",
                ex.Message
            ));
        }
    }
}
