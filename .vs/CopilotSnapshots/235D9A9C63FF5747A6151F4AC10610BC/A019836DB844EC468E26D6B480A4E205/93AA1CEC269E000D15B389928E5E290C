using AutoMapper;
using Miski.Domain.Entities;
using Miski.Shared.DTOs;
using Miski.Shared.DTOs.Auth;
using Miski.Shared.DTOs.Permisos;
using Miski.Shared.DTOs.Personas;
using Miski.Shared.DTOs.Maestros;
using Miski.Shared.DTOs.Ubicaciones;

namespace Miski.Application.Mappings;

public class MappingProfile : Profile
{
    public MappingProfile()
    {
        CreateMap<Negociacion, NegociacionDto>()
            .ForMember(dest => dest.ProveedorNombre, opt => opt.MapFrom(src => 
                src.Proveedor != null ? $"{src.Proveedor.Nombres} {src.Proveedor.Apellidos}" : null))
            .ForMember(dest => dest.ComisionistaNombre, opt => opt.MapFrom(src => 
                $"{src.Comisionista.Nombres} {src.Comisionista.Apellidos}"))
            .ForMember(dest => dest.ProductoNombre, opt => opt.MapFrom(src => 
                src.Producto != null ? src.Producto.Nombre : null))
            .ForMember(dest => dest.AprobadaPorNombre, opt => opt.MapFrom(src => 
                src.AprobadaPorPersona != null ? $"{src.AprobadaPorPersona.Nombres} {src.AprobadaPorPersona.Apellidos}" : null))
            .ForMember(dest => dest.MontoTotal, opt => opt.MapFrom(src => src.PesoTotal * src.PrecioUnitario));

        CreateMap<Producto, ProductoDto>()
            .ForMember(dest => dest.Estado, opt => opt.MapFrom(src => src.Estado ?? "ACTIVO"));

        CreateMap<Persona, PersonaDto>()
            .ForMember(dest => dest.TipoDocumentoNombre, opt => opt.MapFrom(src => src.TipoDocumento.Nombre))
            .ForMember(dest => dest.NombreCompleto, opt => opt.MapFrom(src => $"{src.Nombres} {src.Apellidos}"));

        // Mapeos para Auth
        CreateMap<Persona, AuthPersonaDto>()
            .ForMember(dest => dest.TipoDocumentoNombre, opt => opt.MapFrom(src => 
                src.TipoDocumento != null ? src.TipoDocumento.Nombre : string.Empty))
            .ForMember(dest => dest.NombreCompleto, opt => opt.MapFrom(src => $"{src.Nombres} {src.Apellidos}"));

        CreateMap<Rol, RolDto>()
            .ForMember(dest => dest.TipoPlataforma, opt => opt.MapFrom(src => src.TipoPlataforma));

        CreateMap<Usuario, AuthResponseDto>()
            .ForMember(dest => dest.Token, opt => opt.Ignore())
            .ForMember(dest => dest.Expiration, opt => opt.Ignore())
            .ForMember(dest => dest.Roles, opt => opt.Ignore()); // Se manejará manualmente

        // Mapeos para Permisos
        CreateMap<Modulo, ModuloDto>();
        CreateMap<SubModulo, SubModuloDto>()
            .ForMember(dest => dest.ModuloNombre, opt => opt.MapFrom(src => src.Modulo.Nombre));
        CreateMap<SubModuloDetalle, SubModuloDetalleDto>()
            .ForMember(dest => dest.SubModuloNombre, opt => opt.MapFrom(src => src.SubModulo.Nombre));
        
        CreateMap<PermisoRol, PermisoRolDto>()
            .ForMember(dest => dest.RolNombre, opt => opt.MapFrom(src => src.Rol != null ? src.Rol.Nombre : null))
            .ForMember(dest => dest.ModuloNombre, opt => opt.MapFrom(src => src.Modulo != null ? src.Modulo.Nombre : null))
            .ForMember(dest => dest.SubModuloNombre, opt => opt.MapFrom(src => src.SubModulo != null ? src.SubModulo.Nombre : null))
            .ForMember(dest => dest.SubModuloDetalleNombre, opt => opt.MapFrom(src => src.SubModuloDetalle != null ? src.SubModuloDetalle.Nombre : null));

        // Mapeos para Personas
        CreateMap<Persona, Miski.Shared.DTOs.Personas.PersonaDto>()
            .ForMember(dest => dest.TipoDocumentoNombre, opt => opt.MapFrom(src => 
                src.TipoDocumento != null ? src.TipoDocumento.Nombre : string.Empty))
            .ForMember(dest => dest.NombreCompleto, opt => opt.MapFrom(src => $"{src.Nombres} {src.Apellidos}"))
            .ForMember(dest => dest.Categorias, opt => opt.Ignore()); // Se manejará manualmente si es necesario

        CreateMap<CategoriaPersona, CategoriaPersonaDto>();

        // Mapeos para Maestros - TipoDocumento
        CreateMap<TipoDocumento, TipoDocumentoDto>();

        // Mapeos para Maestros - UnidadMedida
        CreateMap<UnidadMedida, UnidadMedidaDto>();

        // Mapeos para Maestros - CategoriaProducto
        CreateMap<CategoriaProducto, CategoriaProductoDto>();

        // Mapeos para Ubicaciones
        CreateMap<Ubicacion, UbicacionDto>()
            .ForMember(dest => dest.UsuarioNombre, opt => opt.MapFrom(src => 
                src.Usuario != null && src.Usuario.Persona != null 
                    ? $"{src.Usuario.Persona.Nombres} {src.Usuario.Persona.Apellidos}" 
                    : string.Empty));
    }
}

// DTOs adicionales que necesitamos
public class ProductoDto
{
    public int Id { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string Descripcion { get; set; } = string.Empty;
    public string Codigo { get; set; } = string.Empty;
    public decimal PrecioUnitario { get; set; }
    public string UnidadMedida { get; set; } = string.Empty;
    public int StockMinimo { get; set; }
    public int StockActual { get; set; }
    public string Categoria { get; set; } = string.Empty;
    public string Estado { get; set; } = string.Empty;
}

public class PersonaDto
{
    public int Id { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string Apellidos { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string Telefono { get; set; } = string.Empty;
    public string Documento { get; set; } = string.Empty;
    public string TipoDocumento { get; set; } = string.Empty;
    public string TipoPersona { get; set; } = string.Empty;
    public string TipoDocumentoNombre { get; set; } = string.Empty;
    public string NombreCompleto { get; set; } = string.Empty;
}