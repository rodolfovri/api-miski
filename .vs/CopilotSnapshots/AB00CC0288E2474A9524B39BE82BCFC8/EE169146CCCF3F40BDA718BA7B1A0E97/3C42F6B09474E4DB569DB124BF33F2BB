using MediatR;
using Miski.Domain.Contracts;
using Miski.Domain.Entities;
using Miski.Shared.Exceptions;

namespace Miski.Application.Features.Compras.CompraVehiculos.Commands.EliminarCompraDeVehiculo;

public class EliminarCompraDeVehiculoHandler : IRequestHandler<EliminarCompraDeVehiculoCommand, Unit>
{
    private readonly IUnitOfWork _unitOfWork;

    public EliminarCompraDeVehiculoHandler(IUnitOfWork unitOfWork)
    {
        _unitOfWork = unitOfWork;
    }

    public async Task<Unit> Handle(EliminarCompraDeVehiculoCommand request, CancellationToken cancellationToken)
    {
        // 1. Verificar que el CompraVehiculo existe
        var compraVehiculo = await _unitOfWork.Repository<CompraVehiculo>()
            .GetByIdAsync(request.IdCompraVehiculo, cancellationToken);

        if (compraVehiculo == null)
            throw new NotFoundException("CompraVehiculo", request.IdCompraVehiculo);

        // 2. Validar que el CompraVehiculo está en estado ACTIVO
        if (compraVehiculo.Estado != "ACTIVO")
        {
            var errors = new Dictionary<string, string[]>
            {
                { "CompraVehiculo", new[] { "No se puede eliminar la asociación porque el vehículo ya fue entregado a planta" } }
            };
            throw new Shared.Exceptions.ValidationException(errors);
        }

        // 3. Verificar que la Compra existe
        var compra = await _unitOfWork.Repository<Compra>()
            .GetByIdAsync(request.IdCompra, cancellationToken);

        if (compra == null)
            throw new NotFoundException("Compra", request.IdCompra);

        // 4. Validar que la Compra NO ha sido recepcionada
        if (compra.EstadoRecepcion == "RECEPCIONADO")
        {
            var errors = new Dictionary<string, string[]>
            {
                { "Compra", new[] { "No se puede eliminar la asociación porque la compra ya fue recepcionada en planta" } }
            };
            throw new Shared.Exceptions.ValidationException(errors);
        }

        // 5. Validar que la Compra NO tiene llegadas a planta registradas
        var llegadasPlanta = await _unitOfWork.Repository<LlegadaPlanta>()
            .GetAllAsync(cancellationToken);

        var tieneLlegadas = llegadasPlanta.Any(lp => lp.IdCompra == request.IdCompra);

        if (tieneLlegadas)
        {
            var errors = new Dictionary<string, string[]>
            {
                { "Compra", new[] { "No se puede eliminar la asociación porque la compra tiene llegadas a planta registradas" } }
            };
            throw new Shared.Exceptions.ValidationException(errors);
        }

        // 6. Buscar el CompraVehiculoDetalle que asocia esta compra con el vehículo
        var detalles = await _unitOfWork.Repository<CompraVehiculoDetalle>()
            .GetAllAsync(cancellationToken);

        var detalle = detalles.FirstOrDefault(d => 
            d.IdCompraVehiculo == request.IdCompraVehiculo && 
            d.IdCompra == request.IdCompra);

        if (detalle == null)
        {
            var errors = new Dictionary<string, string[]>
            {
                { "CompraVehiculoDetalle", new[] { "No se encontró la asociación entre la compra y el vehículo" } }
            };
            throw new Shared.Exceptions.ValidationException(errors);
        }

        // 7. Eliminar el CompraVehiculoDetalle
        await _unitOfWork.Repository<CompraVehiculoDetalle>().DeleteAsync(detalle, cancellationToken);

        // 8. Actualizar el EstadoRecepcion de la Compra a NULL (ya no está asignada)
        compra.EstadoRecepcion = null;
        await _unitOfWork.Repository<Compra>().UpdateAsync(compra, cancellationToken);

        await _unitOfWork.SaveChangesAsync(cancellationToken);

        return Unit.Value;
    }
}
