# Guía de Configuración y Pruebas - Módulo Negociaciones

## ?? Checklist de Configuración

### 1. ? Crear Directorio de Almacenamiento

```powershell
# En Windows (PowerShell)
New-Item -Path "C:\MiskiFiles" -ItemType Directory -Force
New-Item -Path "C:\MiskiFiles\negociaciones" -ItemType Directory -Force
New-Item -Path "C:\MiskiFiles\negociaciones\calidad" -ItemType Directory -Force
New-Item -Path "C:\MiskiFiles\negociaciones\dni" -ItemType Directory -Force
```

```bash
# En Linux/Mac
mkdir -p /var/www/MiskiFiles/negociaciones/calidad
mkdir -p /var/www/MiskiFiles/negociaciones/dni

# Dar permisos de escritura
chmod -R 755 /var/www/MiskiFiles
```

### 2. ? Verificar Registro en Program.cs

El servicio ya está registrado en `Program.cs`:

```csharp
// File Storage Service
builder.Services.AddScoped<Miski.Application.Services.IFileStorageService, 
                          Miski.Application.Services.LocalFileStorageService>();
```

### 3. ? Verificar Cadena de Conexión

En `appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=TU_SERVIDOR;Database=MiskiDB;..."
  }
}
```

### 4. ? Aplicar Migraciones (si es necesario)

```powershell
dotnet ef database update
```

---

## ?? Guía de Pruebas

### Herramientas Recomendadas
- **Postman** (Recomendado para multipart/form-data)
- **Swagger UI** (http://localhost:5000/swagger)
- **Thunder Client** (VS Code Extension)

---

## ?? Ejemplos de Pruebas con Postman

### 1. Login (Obtener Token)

```http
POST http://localhost:5000/api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "Admin123!"
}
```

**Respuesta:**
```json
{
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiration": "2024-01-15T10:00:00Z"
  }
}
```

**Copiar el token para usar en las siguientes peticiones.**

---

### 2. Crear Negociación (Con Fotos)

**Configuración en Postman:**

1. **Método**: POST
2. **URL**: `http://localhost:5000/api/compras/negociaciones`
3. **Headers**:
   ```
   Authorization: Bearer {TU_TOKEN_AQUI}
   ```
4. **Body** ? seleccionar **form-data**:

| Key | Type | Value |
|-----|------|-------|
| idProveedor | Text | 1 |
| idComisionista | Text | 2 |
| idProducto | Text | 1 |
| pesoTotal | Text | 1500.50 |
| sacosTotales | Text | 60 |
| precioUnitario | Text | 8.50 |
| nroCuentaRuc | Text | 12345678901 |
| fotoCalidadProducto | File | [Seleccionar imagen] |
| fotoDniFrontal | File | [Seleccionar imagen] |
| fotoDniPosterior | File | [Seleccionar imagen] |
| observacion | Text | Producto de alta calidad |
| estado | Text | ACTIVO |

**Respuesta Esperada:**
```json
{
  "success": true,
  "message": "Negociación creada exitosamente",
  "data": {
    "idNegociacion": 1,
    "idProveedor": 1,
    "idComisionista": 2,
    "idProducto": 1,
    "pesoTotal": 1500.50,
    "sacosTotales": 60,
    "precioUnitario": 8.50,
    "nroCuentaRuc": "12345678901",
    "fotoCalidadProducto": "/negociaciones/calidad/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
    "fotoDniFrontal": "/negociaciones/dni/b2c3d4e5-f6a7-8901-bcde-f12345678901.jpg",
    "fotoDniPosterior": "/negociaciones/dni/c3d4e5f6-a7b8-9012-cdef-123456789012.jpg",
    "estadoAprobado": "PENDIENTE",
    "estado": "ACTIVO",
    "fRegistro": "2024-01-15T08:30:00Z",
    "proveedorNombre": "Juan Pérez",
    "comisionistaNombre": "María González",
    "productoNombre": "Café Arábica",
    "montoTotal": 12754.25
  }
}
```

---

### 3. Obtener Todas las Negociaciones

```http
GET http://localhost:5000/api/compras/negociaciones
Authorization: Bearer {TU_TOKEN}
```

**Con Filtros:**
```http
GET http://localhost:5000/api/compras/negociaciones?estadoAprobado=PENDIENTE&idComisionista=2
Authorization: Bearer {TU_TOKEN}
```

---

### 4. Obtener Negociación por ID

```http
GET http://localhost:5000/api/compras/negociaciones/1
Authorization: Bearer {TU_TOKEN}
```

---

### 5. Actualizar Negociación

**Configuración en Postman:**

1. **Método**: PUT
2. **URL**: `http://localhost:5000/api/compras/negociaciones/1`
3. **Headers**:
   ```
   Authorization: Bearer {TU_TOKEN_AQUI}
   ```
4. **Body** ? seleccionar **form-data**:

| Key | Type | Value |
|-----|------|-------|
| idNegociacion | Text | 1 |
| idProveedor | Text | 1 |
| idComisionista | Text | 2 |
| idProducto | Text | 1 |
| pesoTotal | Text | 1600.00 |
| sacosTotales | Text | 65 |
| precioUnitario | Text | 8.75 |
| nroCuentaRuc | Text | 12345678901 |
| fotoCalidadProducto | File | [Opcional - solo si quieres cambiar] |
| observacion | Text | Actualización de pesos |
| estado | Text | ACTIVO |

---

### 6. Aprobar Negociación

```http
PUT http://localhost:5000/api/compras/negociaciones/1/aprobar
Authorization: Bearer {TU_TOKEN}
Content-Type: application/json

{
  "idNegociacion": 1,
  "aprobadaPor": 3,
  "observacion": "Aprobado - Producto de buena calidad"
}
```

---

### 7. Obtener Pendientes de Aprobación

```http
GET http://localhost:5000/api/compras/negociaciones/pendientes-aprobacion
Authorization: Bearer {TU_TOKEN}
```

---

### 8. Eliminar Negociación

```http
DELETE http://localhost:5000/api/compras/negociaciones/1
Authorization: Bearer {TU_TOKEN}
```

---

## ?? Verificaciones Post-Prueba

### 1. Verificar Archivos en Disco

```powershell
# Windows PowerShell
Get-ChildItem -Path "C:\MiskiFiles\negociaciones\" -Recurse
```

```bash
# Linux/Mac
ls -R /var/www/MiskiFiles/negociaciones/
```

**Deberías ver:**
```
C:\MiskiFiles\negociaciones\
??? calidad\
?   ??? a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
??? dni\
    ??? b2c3d4e5-f6a7-8901-bcde-f12345678901.jpg
    ??? c3d4e5f6-a7b8-9012-cdef-123456789012.jpg
```

### 2. Verificar en Base de Datos

```sql
-- Ver negociaciones creadas
SELECT * FROM Negociacion;

-- Ver URLs de fotos
SELECT 
    IdNegociacion,
    FotoCalidadProducto,
    FotoDniFrontal,
    FotoDniPosterior,
    EstadoAprobado
FROM Negociacion;
```

---

## ? Solución de Problemas Comunes

### Error: "Directorio no existe"
```
Solución: Crear manualmente C:\MiskiFiles\ con permisos de escritura
```

### Error: "The ConnectionString property has not been initialized"
```
Solución: Verificar appsettings.json y la cadena de conexión
```

### Error: 401 Unauthorized
```
Solución: Verificar que el token JWT esté en el header Authorization
```

### Error: "Cannot access a disposed object"
```
Solución: Verificar que IFileStorageService esté registrado como Scoped en Program.cs
```

### Error: Fotos no se guardan
```
Solución: 
1. Verificar permisos del directorio C:\MiskiFiles\
2. Ejecutar Visual Studio como Administrador
3. Verificar que no hay antivirus bloqueando
```

---

## ?? Casos de Prueba Recomendados

### Pruebas Positivas ?
- [ ] Crear negociación con los 3 archivos
- [ ] Listar negociaciones sin filtros
- [ ] Listar negociaciones con filtros
- [ ] Obtener negociación por ID válido
- [ ] Actualizar negociación pendiente (con fotos nuevas)
- [ ] Actualizar negociación pendiente (sin cambiar fotos)
- [ ] Aprobar negociación pendiente
- [ ] Listar pendientes de aprobación
- [ ] Eliminar negociación sin compras

### Pruebas Negativas ?
- [ ] Crear sin fotos ? Debe fallar (400)
- [ ] Crear con peso negativo ? Debe fallar (400)
- [ ] Crear con relación peso/sacos incorrecta ? Debe fallar (400)
- [ ] Crear con comisionista inexistente ? Debe fallar (404)
- [ ] Obtener por ID inexistente ? Debe fallar (404)
- [ ] Actualizar negociación aprobada ? Debe fallar (400)
- [ ] Aprobar negociación ya aprobada ? Debe fallar (400)
- [ ] Eliminar negociación con compras ? Debe fallar (400)

---

## ?? Próximos Pasos

1. **Probar todos los endpoints** siguiendo esta guía
2. **Verificar archivos en disco** después de cada operación
3. **Revisar logs** en caso de errores
4. **Documentar problemas** encontrados
5. **Preparar migración** a almacenamiento en la nube

---

## ?? Soporte

Si encuentras problemas:
1. Revisar logs de la aplicación
2. Verificar permisos de carpetas
3. Comprobar cadena de conexión
4. Revisar token JWT válido

---

**Última actualización**: Enero 2024  
**Estado**: ? Listo para pruebas
